{% extends 'base.html' %}

{% block title %}Statistics | {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <h1 class="text-3xl font-bold mb-8">Learning Statistics</h1>

    <!-- Quick Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-blue-50 p-6 rounded-lg text-center">
            <p class="text-3xl font-bold text-blue-600">{{ total_words }}</p>
            <p class="text-sm text-blue-800">Total Words</p>
        </div>
        <div class="bg-green-50 p-6 rounded-lg text-center">
            <p class="text-3xl font-bold text-green-600">{{ known_words_count }}</p>
            <p class="text-sm text-green-800">Words Mastered</p>
        </div>
        <div class="bg-orange-50 p-6 rounded-lg text-center">
            <p class="text-3xl font-bold text-orange-600">{{ learning_words_count }}</p>
            <p class="text-sm text-orange-800">Learning</p>
        </div>
        <div class="bg-purple-50 p-6 rounded-lg text-center">
            <p class="text-3xl font-bold text-purple-600">{{ streak_days }}</p>
            <p class="text-sm text-purple-800">Day Streak</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Daily Learning Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Daily Learning Summary</h2>
            
            <!-- Today's Progress -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Today's Progress</span>
                    <span class="text-sm text-gray-600">{{ words_learned_today }} / {{ daily_target }} new words</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" 
                         style="width: {% widthratio words_learned_today daily_target 100 %}%"></div>
                </div>
            </div>

            <!-- Words Reviewed Today -->
            <div class="mb-6">
                <h3 class="font-semibold mb-3">Words Reviewed Today ({{ words_reviewed_today|length }})</h3>
                <div class="max-h-48 overflow-y-auto space-y-2">
                    {% for word_knowledge in words_reviewed_today %}
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <div>
                                <span class="font-medium">{{ word_knowledge.word.text }}</span>
                                <span class="text-sm text-gray-500 ml-2">(freq: {{ word_knowledge.priority }})</span>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full 
                                {% if word_knowledge.state == 'KNOWN' %}bg-green-100 text-green-800
                                {% elif word_knowledge.state == 'LEARNING' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ word_knowledge.get_state_display }}
                            </span>
                        </div>
                    {% empty %}
                        <p class="text-gray-500 text-sm">No words reviewed today yet.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Learning Activity Chart with Controls -->
            <div class="chart-section">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">Learning Activity</h3>
                    <div class="flex space-x-2">
                        <button id="period-7" class="px-3 py-1 text-sm rounded transition-colors {% if selected_period == '7' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                            Last 7 Days
                        </button>
                        <button id="period-30" class="px-3 py-1 text-sm rounded transition-colors {% if selected_period == '30' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                            Last 30 Days
                        </button>
                    </div>
                </div>
                <div class="chart-container h-64 w-full relative">
                    <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded">
                        <div class="text-gray-500">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading chart...
                        </div>
                    </div>
                    <canvas id="learningChart" class="h-full w-full" style="display: none;"></canvas>
                </div>
            </div>
        </div>

        <!-- Source Comprehension Stats -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Source Comprehension</h2>
            <div class="space-y-4">
                {% for stat in sources_stats %}
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg">{{ stat.source.title }}</h3>
                                <p class="text-sm text-gray-600">{{ stat.source.get_source_type_display }}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold 
                                    {% if stat.comprehension >= 80 %}text-green-600
                                    {% elif stat.comprehension >= 50 %}text-yellow-600
                                    {% else %}text-red-600{% endif %}">
                                    {{ stat.comprehension }}%
                                </span>
                                <p class="text-xs text-gray-500">understood</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-500
                                {% if stat.comprehension >= 80 %}bg-green-500
                                {% elif stat.comprehension >= 50 %}bg-yellow-500
                                {% else %}bg-red-500{% endif %}" 
                                style="width: {{ stat.comprehension }}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            {{ stat.known_words }} / {{ stat.total_words }} words known
                        </p>
                    </div>
                {% empty %}
                    <p class="text-gray-500">No sources added yet.</p>
                {% endfor %}
                {% if sources_stats|length >= 6 %}
                    <p class="text-xs text-gray-500 mt-2">Showing top 6 sources</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Word History Tracker -->
    <div class="bg-white p-6 rounded-lg shadow-md mt-8" id="word-history-section">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Recent Word History</h2>
            <div class="flex space-x-2">
                <button id="filter-all" class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded active-filter">All</button>
                <button id="filter-known" class="px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded">Known</button>
                <button id="filter-learning" class="px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded">Learning</button>
                <button id="filter-today" class="px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded">Today</button>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full table-auto">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-4 py-2 text-left">Word</th>
                        <th class="px-4 py-2 text-left">Frequency</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-left">Last Reviewed</th>
                        <th class="px-4 py-2 text-left">Due Date</th>
                    </tr>
                </thead>
                <tbody id="word-history-table">
                    {% for word_knowledge in recent_words %}
                        <tr class="border-b word-row" 
                            data-state="{{ word_knowledge.state }}" 
                            data-date="{{ word_knowledge.last_review|date:'Y-m-d' }}">
                            <td class="px-4 py-2 font-medium">{{ word_knowledge.word.text }}</td>
                            <td class="px-4 py-2">{{ word_knowledge.priority }}</td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    {% if word_knowledge.state == 'KNOWN' %}bg-green-100 text-green-800
                                    {% elif word_knowledge.state == 'LEARNING' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ word_knowledge.get_state_display }}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-600">
                                {% if word_knowledge.last_review %}
                                    {{ word_knowledge.last_review|date:"M d, Y H:i" }}
                                {% else %}
                                    Never
                                {% endif %}
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-600">
                                {{ word_knowledge.due|date:"M d, Y" }}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">No words reviewed yet.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if recent_words|length >= 20 %}
                <p class="text-xs text-gray-500 mt-2">Showing most recent 20 words for performance</p>
            {% endif %}
        </div>
    </div>

    <!-- Advanced Statistics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8" id="advanced-stats-section">
        
        <!-- Top Frequent Words -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">üèÜ Most Frequent Words in Your Vocabulary</h2>
            <div class="space-y-3">
                {% for word_knowledge in top_frequent_words %}
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                {{ forloop.counter }}
                            </div>
                            <div>
                                <span class="font-semibold text-lg text-gray-900">{{ word_knowledge.word.text }}</span>
                                {% if word_knowledge.word.definition %}
                                    <p class="text-xs text-gray-600 mt-1 max-w-xs truncate" title="{{ word_knowledge.word.definition }}">
                                        {{ word_knowledge.word.definition }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-700">
                                    {{ word_knowledge.priority }} priority score
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ word_knowledge.successful_reviews }} successful reviews
                                </div>
                            </div>
                            <div class="w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-2 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all duration-500" 
                                     style="width: {% if word_knowledge.priority > 0 and max_frequency > 0 %}{% widthratio word_knowledge.priority max_frequency 100 %}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">üìö</div>
                        <p class="text-gray-500 text-lg font-medium">No words in your vocabulary yet</p>
                        <p class="text-gray-400 text-sm mt-2">Add some sources and complete your first review session to see your most frequent words here</p>
                        <div class="mt-4 space-x-2">
                            <a href="{% url 'source_list' %}" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                Add Sources
                            </a>
                            <a href="{% url 'review_page' %}" class="inline-block px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                Start Learning
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            {% if top_frequent_words %}
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-700">
                        <strong>üìä How it works:</strong> This shows your most frequently encountered words across all sources, including both mastered words and those you're currently learning. 
                        Frequency is based on how often these words appeared in your reading materials.
                    </p>
                </div>
            {% endif %}
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Performance Metrics</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">Review Success Rate</span>
                    <span class="text-xl font-bold text-green-600">{{ success_rate }}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">Total Reviews</span>
                    <span class="text-xl font-bold text-blue-600">{{ total_reviews }}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">Learning Streak</span>
                    <span class="text-xl font-bold text-purple-600">{{ streak_days }} days</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">Mastery Rate</span>
                    <span class="text-xl font-bold text-orange-600">
                        {% if total_words > 0 %}
                            {% widthratio known_words_count total_words 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Word Frequency Table -->
    <div class="bg-white p-6 rounded-lg shadow-md mt-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
            <h2 class="text-2xl font-bold mb-4 sm:mb-0">All Words Frequency Table</h2>
            <div class="text-sm text-gray-600">
                Showing {{ words_data|length }} of {{ total_filtered_words }} total words
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="flex flex-col lg:flex-row gap-4 mb-6">
            <!-- Search Box -->
            <div class="flex-1">
                <input type="text" id="word-search" placeholder="Search words..." 
                       value="{{ current_search }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Filters and Sorting -->
            <div class="flex flex-wrap gap-2">
                <!-- Status Filter -->
                <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Words</option>
                    <option value="known" {% if current_status == 'known' %}selected{% endif %}>Known Only</option>
                    <option value="unknown" {% if current_status == 'unknown' %}selected{% endif %}>Unknown Only</option>
                </select>
                
                <!-- Sort Options -->
                <select id="sort-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="frequency-desc" {% if current_sort == 'frequency' and current_order == 'desc' %}selected{% endif %}>Frequency ‚Üì</option>
                    <option value="frequency-asc" {% if current_sort == 'frequency' and current_order == 'asc' %}selected{% endif %}>Frequency ‚Üë</option>
                    <option value="word-asc" {% if current_sort == 'word' and current_order == 'asc' %}selected{% endif %}>Word A-Z</option>
                    <option value="word-desc" {% if current_sort == 'word' and current_order == 'desc' %}selected{% endif %}>Word Z-A</option>
                    <option value="status-asc" {% if current_sort == 'status' and current_order == 'asc' %}selected{% endif %}>Status ‚Üë</option>
                </select>
            </div>
        </div>

        <!-- Words Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Word</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sources</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in words_data %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-lg font-medium text-gray-900 font-mono">{{ item.word.text }}</div>
                            {% if item.word.definition %}
                                <div class="text-xs text-gray-500 mt-1 max-w-xs truncate" title="{{ item.word.definition }}">
                                    {{ item.word.definition }}
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ item.knowledge.priority }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if item.knowledge.state == 'KNOWN' %}
                                    bg-green-100 text-green-800
                                {% elif item.knowledge.state == 'LEARNING' %}
                                    bg-yellow-100 text-yellow-800
                                {% elif item.knowledge.state == 'NEW' %}
                                    bg-gray-100 text-gray-800
                                {% else %}
                                    bg-red-100 text-red-800
                                {% endif %}">
                                {{ item.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if item.knowledge.state == 'KNOWN' %}
                                <span class="text-green-600 text-sm font-medium">‚úì Mastered</span>
                            {% else %}
                                <div class="flex items-center space-x-2">
                                    <div class="text-xs text-gray-600">
                                        {{ item.successful_reviews }}/{{ item.knowledge.user.profile.known_threshold }} successful
                                    </div>
                                    <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" 
                                             style="width: {% widthratio item.successful_reviews item.knowledge.user.profile.known_threshold 100 %}%"></div>
                                    </div>
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">
                                {% for source in item.sources %}
                                    <span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs mr-1 mb-1">
                                        {{ source|truncatechars:15 }}
                                    </span>
                                {% endfor %}
                                {% if item.sources_count > 3 %}
                                    <span class="text-xs text-gray-400">+{{ item.sources_count|add:"-3" }} more</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if not item.is_known %}
                                <button onclick="toggleWordStatus({{ item.word.id }}, '{{ item.word.text }}')" 
                                        class="text-green-600 hover:text-green-800 font-medium mr-3">
                                    Mark Known
                                </button>
                            {% endif %}
                            <button onclick="showWordDetails({{ item.knowledge.id }})" 
                                    class="text-blue-600 hover:text-blue-800 font-medium">
                                Details
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <div class="text-4xl mb-4">üìö</div>
                                <div class="text-lg font-medium mb-2">No words found</div>
                                <div class="text-sm">Try adjusting your search or filter criteria</div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-6">
            <div class="flex flex-1 justify-between sm:hidden">
                {% if page_obj.has_previous %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
                       class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Previous
                    </a>
                {% endif %}
                {% if page_obj.has_next %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
                       class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Next
                    </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing
                        <span class="font-medium">{{ page_obj.start_index }}</span>
                        to
                        <span class="font-medium">{{ page_obj.end_index }}</span>
                        of
                        <span class="font-medium">{{ page_obj.paginator.count }}</span>
                        words
                    </p>
                </div>
                <div>
                    <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                        {% if page_obj.has_previous %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
                               class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}"
                                   class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">{{ num }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
                               class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let learningChart = null;
    const dailyData = {{ daily_learning_data|safe }};
    
    // Chart configuration with performance optimizations
    const chartConfig = {
        type: 'line',
        data: {
            labels: dailyData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Words Reviewed',
                data: dailyData.map(d => d.words),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 750, // Reduced animation time
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        maxTicksLimit: 8 // Limit ticks for better performance
                    }
                },
                x: {
                    ticks: {
                        maxTicksLimit: dailyData.length > 14 ? 8 : dailyData.length // Adaptive tick limit
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    cornerRadius: 4
                }
            },
            elements: {
                point: {
                    hoverBackgroundColor: 'rgb(59, 130, 246)'
                }
            }
        }
    };

    // Lazy loading with Intersection Observer
    const chartContainer = document.querySelector('.chart-container');
    const chartCanvas = document.getElementById('learningChart');
    const loadingDiv = document.getElementById('chart-loading');
    
    const chartObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Delay chart creation slightly to improve perceived performance
                setTimeout(() => {
                    createChart();
                    chartObserver.unobserve(chartContainer);
                }, 300);
            }
        });
    }, { threshold: 0.1 });

    function createChart() {
        const ctx = chartCanvas.getContext('2d');
        learningChart = new Chart(ctx, chartConfig);
        
        // Hide loading and show chart
        loadingDiv.style.display = 'none';
        chartCanvas.style.display = 'block';
    }

    // Start observing the chart container
    chartObserver.observe(chartContainer);

    // Time period toggle functionality
    const periodButtons = document.querySelectorAll('[id^="period-"]');
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            const period = this.id.replace('period-', '');
            
            // Show loading state
            if (learningChart) {
                learningChart.destroy();
                learningChart = null;
            }
            chartCanvas.style.display = 'none';
            loadingDiv.style.display = 'flex';
            
            // Navigate to new period
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.location.href = url.toString();
        });
    });

    // Lazy loading for other sections
    const observerOptions = { threshold: 0.1, rootMargin: '50px' };
    
    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
                sectionObserver.unobserve(entry.target);
            }
        });
    }, observerOptions);

    // Initialize lazy loaded sections
    const lazySection = document.getElementById('advanced-stats-section');
    if (lazySection) {
        lazySection.style.opacity = '0';
        lazySection.style.transform = 'translateY(20px)';
        lazySection.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        sectionObserver.observe(lazySection);
    }

    // Word History Filters (optimized)
    const filterButtons = document.querySelectorAll('[id^="filter-"]');
    const wordRows = document.querySelectorAll('.word-row');
    const today = new Date().toISOString().split('T')[0];

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active filter button
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-800', 'active-filter');
                btn.classList.add('bg-gray-100', 'text-gray-800');
            });
            this.classList.remove('bg-gray-100', 'text-gray-800');
            this.classList.add('bg-blue-100', 'text-blue-800', 'active-filter');

            // Filter rows with requestAnimationFrame for better performance
            const filterType = this.id.replace('filter-', '');
            
            requestAnimationFrame(() => {
                wordRows.forEach(row => {
                    let show = true;
                    
                    if (filterType === 'known') {
                        show = row.dataset.state === 'KNOWN';
                    } else if (filterType === 'learning') {
                        show = row.dataset.state === 'LEARNING';
                    } else if (filterType === 'today') {
                        show = row.dataset.date === today;
                    }
                    
                    row.style.display = show ? '' : 'none';
                });
            });
        });
    });

    // Word Frequency Table functionality
    const wordSearch = document.getElementById('word-search');
    const statusFilter = document.getElementById('status-filter');
    const sortSelect = document.getElementById('sort-select');

    // Apply filters function
    function applyFilters() {
        const params = new URLSearchParams(window.location.search);
        
        const search = wordSearch.value.trim();
        if (search) {
            params.set('search', search);
        } else {
            params.delete('search');
        }
        
        const status = statusFilter.value;
        if (status !== 'all') {
            params.set('status', status);
        } else {
            params.delete('status');
        }
        
        const sortValue = sortSelect.value;
        const [sort, order] = sortValue.split('-');
        params.set('sort', sort);
        params.set('order', order);
        
        // Reset to first page when filtering
        params.delete('page');
        
        window.location.search = params.toString();
    }

    // Event listeners for word table filters
    if (wordSearch) {
        wordSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // Auto-search after 500ms of no typing
        let searchTimeout;
        wordSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 500);
        });
    }

    if (statusFilter) {
        statusFilter.addEventListener('change', applyFilters);
    }

    if (sortSelect) {
        sortSelect.addEventListener('change', applyFilters);
    }
});

// Word table action functions
function toggleWordStatus(wordId, wordText) {
    if (!confirm(`Mark "${wordText}" as known?`)) return;
    
    fetch('/api/mark-known/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            word_id: wordId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            // Show success message
            showNotification(`"${wordText}" marked as known!`, 'success');
            // Reload page to show updated status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('Error marking word as known', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error marking word as known', 'error');
    });
}

function showWordDetails(knowledgeId) {
    // This could open a modal or navigate to a detail page
    // For now, just show an alert with more info
    alert(`Word details for knowledge ID: ${knowledgeId}\n\nThis could show:\n- Full review history\n- All source appearances\n- Learning progress timeline\n- FSRS statistics`);
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
        type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
        'bg-blue-100 border border-blue-400 text-blue-700'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 